<!DOCTYPE html>
<html lang="fr">
<head>
            <title>Cyclopy - Django REST API #2 : Les filtres</title>
        <meta charset="utf-8" />

        <!-- Author -->
        <meta name="author" content="Marc-Aurele Coste">

        <!-- Foundation CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/foundation-sites@6.5.3/dist/css/foundation.min.css" integrity="sha256-xpOKVlYXzQ3P03j397+jWFZLMBXLES3IiryeClgU5og= sha384-gP4DhqyoT9b1vaikoHi9XQ8If7UNLO73JFOOlQV1RATrA7D0O7TjJZifac6NwPps sha512-AKwIib1E+xDeXe0tCgbc9uSvPwVYl6Awj7xl0FoaPFostZHOuDQ1abnDNCYtxL/HWEnVOMrFyf91TDgLPi9pNg==" crossorigin="anonymous">

        <!-- FontAwesome -->
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">

        <!-- Theme CSS -->
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!-- IE -->
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie.css"/>
                <script src="/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie6.css"/><![endif]-->






        <meta name="tags" content="Python" />
        <meta name="tags" content="Django" />
        <meta name="tags" content="REST API" />

</head>

<body id="index" class="home">

    <div class="grid-y medium-grid-frame">
        <div class="cell shrink header medium-cell-block-container">
            <!-- Topbar -->
            <div class="top-bar">

                <div class="top-bar-left">
                    <ul class="dropdown menu" data-dropdown-menu>
                        <!-- <li class="menu-text">Cyclopy</li> -->
                        <li>
                            <a class="topbar-title" href="/">Cyclopy</a>
                        </li>


                        <li>
                            <a href="/pages/about.html">A propos</a>
                            </li>

                            <li class="has-submenu">
                                <a href="#0">Catégories</a>
                                <ul class="submenu menu vertical" data-submenu>
                                    <li class="active" >
                                        <a href="/category/developpement.html">Développement</a>
                            </li>
                                    <li>
                                        <a href="/category/linux.html">Linux</a>
                            </li>
                    </ul>
                    </li>
                    </ul>
                </div>

                <div class="top-bar-right">
                </div>
            </div>
        </div>

        <div class="cell medium-auto medium-cell-block-container">
            <div class="cell medium-8 medium-cell-block-y">
                <div class="grid-x grid-padding-x">
                <div class="grid-container">
<section id="content" class="body">
    <header>
        <h2 class="entry-title">
            <a href="/django-rest-api-02.html" rel="bookmark" title="Permalink to Django REST API #2 : Les filtres">
                Django REST API #2 : Les filtres
            </a>
        </h2>

        
    </header>

    <footer class="post-info">
        <time class="published" datetime="2019-02-25T20:35:00+01:00">
            Mon 25 February 2019
        </time>

            <time class="modified" datetime="2019-02-25T20:35:00+01:00">
                Mon 25 February 2019
            </time>

            <!-- <address class="vcard author">
                By                     <a class="url fn" href="/author/marc-aurele-coste.html">Marc-Aurele Coste</a>
            </address> -->

            <div class="category">
                Category: <a href="/category/developpement.html">Développement</a>
            </div>

            <div class="tags">
                Tags:
                    <a href="/tag/python.html">Python</a>
                    <a href="/tag/django.html">Django</a>
                    <a href="/tag/rest-api.html">REST API</a>
            </div>
    </footer><!-- /.post-info -->

    <div class="entry-content">
        <p>On a vu comment faire une API REST avec Django et Django REST Framework. On va maintenant améliorer ce que nous avons en ajoutant la possibilité de filtrer les éléments que nous retourne notre API.</p>
<p>Pour cela il nous faut tout d'abord installer le paquet <span class="blue">django-filter</span>.</p>
<div class="highlight"><pre><span></span>pip install django-filter
</pre></div>
<p>On fait les changements nécessaires dans les settings.</p>
<p><span class="green">INSTALLED_APPS</span>: <span class="red">common.py</span></p>
<blockquote>
<div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span>
    <span class="s1">&#39;django_filters&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</blockquote>
<p><span class="green">REST_FRAMEWORK</span>: <span class="red">common.py</span></p>
<blockquote>
<div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="s1">&#39;DEFAULT_FILTER_BACKENDS&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;django_filters.rest_framework.DjangoFilterBackend&#39;</span><span class="p">,)</span>
<span class="p">}</span>
</pre></div>
</blockquote>
<div class="section" id="filtrage-basique">
<h2>Filtrage basique</h2>
<p>Maintenant on ajoute dans notre application un nouveau fichier <strong>filters.py</strong> dans lequel on va déclarer notre classe qui servira à filtrer les résultats.</p>
<div class="highlight"><pre><span></span><span class="c1"># filters.py</span>
<span class="kn">from</span> <span class="nn">django_filters</span> <span class="kn">import</span> <span class="n">FilterSet</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Todo</span>


<span class="k">class</span> <span class="nc">TodoFilter</span><span class="p">(</span><span class="n">FilterSet</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Todo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;finished&#39;</span>
        <span class="p">]</span>
</pre></div>
<p>On ajoute ensuite cette classe dans notre viewset.</p>
<div class="highlight"><pre><span></span><span class="c1"># views.py</span>
<span class="o">...</span>
<span class="kn">from</span> <span class="nn">.filters</span> <span class="kn">import</span> <span class="n">TodoFilter</span>

<span class="k">class</span> <span class="nc">TodoViewset</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">filter_class</span> <span class="o">=</span> <span class="n">TodoFilter</span>
</pre></div>
<p>Voilà on peut se rendre sur <a class="reference external" href="http://locahost:8000/api/todo/">locahost:8000/api/todo/</a> et voir en haut à droite un nouveau bouton <strong>Filters</strong></p>
<img alt="bouton Filters" class="align-center" src="/static/images/django_rest_api/filters_button.png" style="width: 723.6px; height: 165.6px;" />
<p>On peut maintenant filtrer nos résultats.</p>
</div>
<div class="section" id="filtrage-avec-des-booleens">
<h2>Filtrage avec des booléens</h2>
<p>Nous avons dans la liste des champs (fields) <span class="red">finished</span> qui est de type booléen. Le problème est que l'URL final ressemble à ceci lorsque l'on essaie de filtrer sur ce champ.</p>
<blockquote>
127.0.0.1:8000/api/todo/?finished=2</blockquote>
<p>On aimerait plutôt quelque chose dans ce genre:</p>
<blockquote>
127.0.0.1:8000/api/todo/?finished=true</blockquote>
<p>Nous allons donc préciser le type de ce champ dans notre classe de filtre. Pour cela on déclare notre champ comme un attribut de notre classe comme ci-dessous.</p>
<div class="highlight"><pre><span></span><span class="c1"># filters.py</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">TodoFilter</span><span class="p">(</span><span class="n">FilterSet</span><span class="p">):</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">BooleanFilter</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Todo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;finished&#39;</span>
        <span class="p">]</span>
</pre></div>
</div>
<div class="section" id="filtrage-avec-des-listes">
<h2>Filtrage avec des listes</h2>
<p>On aimerait maintenant filtrer nos résultats en utilisant une liste d'ids. On ne peut pas passer directement <strong>id</strong> dans la liste des champs (fields) car on ne pourrait filtrer que sur un seul id et notre API nous permet déjà de faire ça en ajoutant l'id à la fin de notre URL.</p>
<p>Le package django_filters dispose déjà de ce que nous recherchons, il s'agit du <strong>BaseInFilter</strong></p>
<div class="highlight"><pre><span></span><span class="c1"># filters.py</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">TodoFilter</span><span class="p">(</span><span class="n">FilterSet</span><span class="p">):</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">BaseInFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">)</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">BooleanFilter</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Todo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;finished&#39;</span>
        <span class="p">]</span>
</pre></div>
<p>Ici notre attribut ne portant pas le même nom que l'attribut du modèle il nous faut préciser le <strong>field_name</strong>. Nous pouvons maintenant utiliser facilement notre API avec du JavaScript par exemple.</p>
<div class="highlight"><pre><span></span><span class="nx">ids</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`localhost:8000/api/todo/?ids=</span><span class="si">${</span><span class="nx">ids</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="c1">// return localhost:8000/api/todo/?ids=1,3</span>
</pre></div>
</div>
<div class="section" id="petit-plus">
<h2>Petit plus</h2>
<p>Nous avons une classe qui nous permet de filtrer nos résultats. On peut notamment chercher une tâche en entrant son titre complet. Dans la vraie vie, en revanche, le plus souvent on ne se souvient pas du titre exact de ce que nous cherchons mais seulement des mots-clés.</p>
<p>On va modifier légèrement notre classe de filtre afin de permettre ce type de recherches.</p>
<div class="highlight"><pre><span></span><span class="c1"># filters.py</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">TodoFilter</span><span class="p">(</span><span class="n">FilterSet</span><span class="p">):</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">BaseInFilter</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">lookup_expr</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">)</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">BooleanFilter</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">():</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Todo</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ids&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;icontains&#39;</span><span class="p">],</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;icontains&#39;</span><span class="p">],</span>
            <span class="s1">&#39;finished&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
</pre></div>
<p>Dans cet exemple nous précisons que nous cherchons à faire un test d'inclusion pour le <strong>title</strong> et pour la <strong>description</strong>.</p>
<p>Voici quelques possibilités de tests offertes par Django (la liste complète se trouve <a class="reference external" href="https://docs.djangoproject.com/fr/2.1/ref/models/querysets/#field-lookups">ici</a>)</p>
<dl class="docutils">
<dt><span class="blue">exact</span></dt>
<dd>Correspondance exacte.</dd>
<dt><span class="blue">iexact</span></dt>
<dd>Correspondance exacte insensible à la casse.</dd>
<dt><span class="blue">contains</span></dt>
<dd>Test d’inclusion sensible à la casse.</dd>
<dt><span class="blue">icontains</span></dt>
<dd>Test d’inclusion insensible à la casse.</dd>
<dt><span class="blue">gt</span></dt>
<dd>Plus grand que.</dd>
<dt><span class="blue">lt</span></dt>
<dd>Plus petit que.</dd>
<dt><span class="blue">startswith</span></dt>
<dd>Commence par (sensible à la casse).</dd>
<dt><span class="blue">endswith</span></dt>
<dd>Se termine par (sensible à la casse).</dd>
</dl>
<p>Voilà c'est tout pour la partie filtrage. Cela vous permettra d'obtenir une API assez flexible sur les données retournées et vous évitera un traitement côté client.</p>
<hr class="docutils" />
<p><strong>Partie 03</strong> : <a class="reference external" href="/drafts/django-rest-api-03.html">Authentification / Permissions</a></p>
</div>

    </div><!-- /.entry-content -->
</section>
                </div>
                </div>
            </div>
        </div>

        <div class="cell shrink footer">
            <footer class="main-footer">
                <div class="grid-container">
                    <div class="grid-x grid-padding-x">
                        
                        <div class="cell auto">
                            
                        </div>

                        <div class="cell auto">
                            <address id="about" class="vcard body">
                                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of
                                <a href="http://python.org">Python</a>.
                            </address>
                        </div>
                        
                        <div class="cell auto">
                            <!-- <div class="grid-y">
                                <div class="cell auto">
                                    <a href="www.linkedin.com/in/marc-aurèle-c-5501b2a5">
                                        <i class="footer-social fab fa-linkedin"></i>
                                    </a>
                                </div>
                            </div> -->
                        </div>

                    </div>
                </div>
            </footer>
        </div>
    </div>

    <!-- JQuery -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script>
    <!-- Foundation JS -->
    <script src="https://cdn.jsdelivr.net/npm/foundation-sites@6.5.3/dist/js/foundation.min.js" integrity="sha256-/PFxCnsMh+nTuM0k3VJCRch1gwnCfKjaP8rJNq5SoBg= sha384-9ksAFjQjZnpqt6VtpjMjlp2S0qrGbcwF/rvrLUg2vciMhwc1UJJeAAOLuJ96w+Nj sha512-UMSn6RHqqJeJcIfV1eS2tPKCjzaHkU/KqgAnQ7Nzn0mLicFxaVhm9vq7zG5+0LALt15j1ljlg8Fp9PT1VGNmDw==" crossorigin="anonymous"></script>
    <script>
        $(document).foundation();
    </script>
</body>
</html>